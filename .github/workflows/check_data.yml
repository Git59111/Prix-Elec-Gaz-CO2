name: ⚠️ Alerte – Prix ELEC non disponibles aujourd’hui

on:
  workflow_dispatch:        # manual trigger
  workflow_run:             # automatic trigger after extraction
    workflows: ["Extract EPEX data from HTML"]
    types:
      - completed

jobs:
  check-data:
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas openpyxl

      - name: Run data check
        id: check
        run: |
          echo "Running Excel data verification..."
          python check_data_completeness.py

      - name: Create issue if data missing
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = "Data Check Failed - Missing Electricity Data";
            const body = [
              "The EPEX data verification workflow failed.",
              "",
              "The last electricity day column contains 24 empty or '-' values.",
              "",
              "Check the workflow logs for more details:",
              "https://github.com/" + context.repo.owner + "/" + context.repo.repo + "/actions/runs/" + context.runId
            ].join("\n");
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body
            });

